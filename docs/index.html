<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarah's TODO</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .sync-bar {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-pull {
            background: #48bb78;
            color: white;
        }
        
        .btn-pull:active {
            background: #38a169;
        }
        
        .btn-push {
            background: #4299e1;
            color: white;
        }
        
        .btn-push:active {
            background: #3182ce;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }
        
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
        }
        
        .task {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            margin-bottom: 8px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .task input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .task-text {
            flex: 1;
            line-height: 1.5;
            color: #2d3748;
            word-wrap: break-word;
        }
        
        .task.completed .task-text {
            text-decoration: line-through;
            color: #a0aec0;
        }
        
        .task-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .task-buttons button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .task-buttons button:hover {
            background: #edf2f7;
        }
        
        /* SUBTASKS STYLING - CLEAN AND SIMPLE */
        .subtasks {
            margin: 10px 0 0 40px;
            padding: 10px;
            border-left: 3px solid #9f7aea;
            background: #faf5ff;
            border-radius: 4px;
        }
        
        .subtask {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            margin-bottom: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9d8fd;
        }
        
        .subtask input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .subtask-text {
            flex: 1;
            font-size: 0.92em;
            line-height: 1.4;
            color: #4a5568;
            word-wrap: break-word;
        }
        
        .subtask.completed .subtask-text {
            text-decoration: line-through;
            color: #a0aec0;
        }
        
        .subtask-buttons {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .subtask-buttons button {
            background: none;
            border: none;
            font-size: 1em;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .subtask-buttons button:hover {
            background: #f3e8ff;
        }
        
        .add-task-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sarah's TODO</h1>
            <p>v7.0 - Clean Build</p>
        </div>
        
        <div class="sync-bar">
            <button class="btn btn-pull" onclick="app.pullFromGitHub()">‚¨áÔ∏è Pull Latest</button>
            <button class="btn btn-push" onclick="app.pushToGitHub()">‚¨ÜÔ∏è Save Changes</button>
        </div>
        
        <div id="sections"></div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <script>
        const GITHUB_TOKEN = localStorage.getItem('gh_token') || prompt('Paste GitHub token:');
        const GITHUB_REPO = 'MotherOfChaos/Life-Operating-System';
        const GITHUB_FILE = 'PERMANENT_TODO.md';
        
        const app = {
            data: {
                sections: [],
                lastSHA: null
            },
            
            async init() {
                await this.loadFromLocalStorage();
                this.render();
            },
            
            async loadFromLocalStorage() {
                const saved = localStorage.getItem('todoData');
                if (saved) {
                    this.data = JSON.parse(saved);
                }
            },
            
            async saveToLocalStorage() {
                localStorage.setItem('todoData', JSON.stringify(this.data));
            },
            
            async pullFromGitHub() {
                try {
                    const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3.raw'
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch');
                    
                    const markdown = await response.text();
                    this.data.sections = this.parseMarkdown(markdown);
                    
                    // Get SHA for later push
                    const shaResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    const shaData = await shaResponse.json();
                    this.data.lastSHA = shaData.sha;
                    
                    await this.saveToLocalStorage();
                    this.render();
                    this.showToast('‚úÖ Pulled from GitHub!');
                } catch (error) {
                    this.showToast('‚ùå Pull failed: ' + error.message);
                }
            },
            
            async pushToGitHub() {
                try {
                    const markdown = this.generateMarkdown();
                    const encoded = btoa(unescape(encodeURIComponent(markdown)));
                    
                    const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`;
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: `TODO update - ${new Date().toLocaleString()}`,
                            content: encoded,
                            sha: this.data.lastSHA
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to push');
                    
                    const data = await response.json();
                    this.data.lastSHA = data.content.sha;
                    await this.saveToLocalStorage();
                    this.showToast('‚úÖ Saved to GitHub!');
                } catch (error) {
                    this.showToast('‚ùå Push failed: ' + error.message);
                }
            },
            
            parseMarkdown(md) {
                const sections = [];
                const lines = md.split('\n');
                let currentSection = null;
                let currentTask = null;
                let taskId = 1;
                
                for (let line of lines) {
                    const trimmed = line.trim();
                    
                    // Section header
                    if (trimmed.startsWith('## ')) {
                        if (currentSection) sections.push(currentSection);
                        currentSection = {
                            id: 'section-' + sections.length,
                            title: trimmed.substring(3).trim(),
                            tasks: []
                        };
                        currentTask = null;
                    }
                    // Main task (starts with "- [ ]" or "- [x]")
                    else if (trimmed.match(/^- \[(x| )\] /) && currentSection) {
                        const completed = trimmed.includes('[x]');
                        const text = trimmed.substring(6).trim();
                        currentTask = {
                            id: taskId++,
                            text: text,
                            completed: completed,
                            subtasks: []
                        };
                        currentSection.tasks.push(currentTask);
                    }
                    // Subtask (indented with 2+ spaces)
                    else if (line.match(/^  +- \[(x| )\] /) && currentTask) {
                        const completed = trimmed.includes('[x]');
                        const text = trimmed.substring(6).trim();
                        currentTask.subtasks.push({
                            id: taskId++,
                            text: text,
                            completed: completed
                        });
                    }
                }
                
                if (currentSection) sections.push(currentSection);
                return sections;
            },
            
            generateMarkdown() {
                let md = '# SARAH\'S PERMANENT TO-DO LIST\n\n**Always updated**\n';
                md += `**Last updated:** ${new Date().toLocaleDateString()}\n\n---\n\n`;
                
                this.data.sections.forEach(section => {
                    md += `## ${section.title}\n\n`;
                    section.tasks.forEach(task => {
                        md += `- ${task.completed ? '[x]' : '[ ]'} ${task.text}\n`;
                        // Add subtasks with indentation
                        if (task.subtasks && task.subtasks.length > 0) {
                            task.subtasks.forEach(sub => {
                                md += `  - ${sub.completed ? '[x]' : '[ ]'} ${sub.text}\n`;
                            });
                        }
                    });
                    md += '\n';
                });
                
                return md;
            },
            
            render() {
                const container = document.getElementById('sections');
                container.innerHTML = '';
                
                this.data.sections.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section';
                    
                    const header = document.createElement('div');
                    header.className = 'section-header';
                    header.innerHTML = `<div class="section-title">${section.title}</div>`;
                    sectionDiv.appendChild(header);
                    
                    section.tasks.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'task' + (task.completed ? ' completed' : '');
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = task.completed;
                        checkbox.onchange = () => this.toggleTask(section.id, task.id);
                        
                        const text = document.createElement('div');
                        text.className = 'task-text';
                        text.textContent = task.text;
                        
                        const buttons = document.createElement('div');
                        buttons.className = 'task-buttons';
                        buttons.innerHTML = `
                            <button onclick="app.addSubtask('${section.id}', ${task.id})" title="Add subtask">+</button>
                            <button onclick="app.editTask('${section.id}', ${task.id})" title="Edit">‚úèÔ∏è</button>
                            <button onclick="app.deleteTask('${section.id}', ${task.id})" title="Delete">üóëÔ∏è</button>
                        `;
                        
                        taskDiv.appendChild(checkbox);
                        taskDiv.appendChild(text);
                        taskDiv.appendChild(buttons);
                        
                        // Add subtasks if they exist
                        if (task.subtasks && task.subtasks.length > 0) {
                            const subtasksDiv = document.createElement('div');
                            subtasksDiv.className = 'subtasks';
                            
                            task.subtasks.forEach((subtask, idx) => {
                                const subDiv = document.createElement('div');
                                subDiv.className = 'subtask' + (subtask.completed ? ' completed' : '');
                                
                                const subCheckbox = document.createElement('input');
                                subCheckbox.type = 'checkbox';
                                subCheckbox.checked = subtask.completed;
                                subCheckbox.onchange = () => this.toggleSubtask(section.id, task.id, idx);
                                
                                const subText = document.createElement('div');
                                subText.className = 'subtask-text';
                                subText.textContent = subtask.text;
                                
                                const subButtons = document.createElement('div');
                                subButtons.className = 'subtask-buttons';
                                subButtons.innerHTML = `
                                    <button onclick="app.editSubtask('${section.id}', ${task.id}, ${idx})" title="Edit">‚úèÔ∏è</button>
                                    <button onclick="app.deleteSubtask('${section.id}', ${task.id}, ${idx})" title="Delete">‚úï</button>
                                `;
                                
                                subDiv.appendChild(subCheckbox);
                                subDiv.appendChild(subText);
                                subDiv.appendChild(subButtons);
                                subtasksDiv.appendChild(subDiv);
                            });
                            
                            taskDiv.appendChild(subtasksDiv);
                        }
                        
                        sectionDiv.appendChild(taskDiv);
                    });
                    
                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-task-btn';
                    addBtn.textContent = '+ Add Task';
                    addBtn.onclick = () => this.addTask(section.id);
                    sectionDiv.appendChild(addBtn);
                    
                    container.appendChild(sectionDiv);
                });
            },
            
            async toggleTask(sectionId, taskId) {
                const section = this.data.sections.find(s => s.id === sectionId);
                const task = section.tasks.find(t => t.id === taskId);
                task.completed = !task.completed;
                await this.saveToLocalStorage();
                this.render();
            },
            
            async toggleSubtask(sectionId, taskId, subIdx) {
                const section = this.data.sections.find(s => s.id === sectionId);
                const task = section.tasks.find(t => t.id === taskId);
                task.subtasks[subIdx].completed = !task.subtasks[subIdx].completed;
                await this.saveToLocalStorage();
                this.render();
            },
            
            async addTask(sectionId) {
                const text = prompt('New task:');
                if (!text || !text.trim()) return;
                
                const section = this.data.sections.find(s => s.id === sectionId);
                const maxId = Math.max(...section.tasks.map(t => t.id), 0);
                section.tasks.push({
                    id: maxId + 1,
                    text: text.trim(),
                    completed: false,
                    subtasks: []
                });
                
                await this.saveToLocalStorage();
                this.render();
                this.showToast('‚úÖ Task added!');
            },
            
            async addSubtask(sectionId, taskId) {
                const text = prompt('New subtask:');
                if (!text || !text.trim()) return;
                
                const section = this.data.sections.find(s => s.id === sectionId);
                const task = section.tasks.find(t => t.id === taskId);
                const maxId = task.subtasks.length > 0 ? Math.max(...task.subtasks.map(s => s.id)) : taskId * 10;
                
                task.subtasks.push({
                    id: maxId + 1,
                    text: text.trim(),
                    completed: false
                });
                
                await this.saveToLocalStorage();
                this.render();
                this.showToast('‚úÖ Subtask added!');
            },
            
            async editTask(sectionId, taskId) {
                const section = this.data.sections.find(s => s.id === sectionId);
                const task = section.tasks.find(t => t.id === taskId);
                const newText = prompt('Edit task:', task.text);
                
                if (newText && newText.trim() && newText.trim() !== task.text) {
                    task.text = newText.trim();
                    await this.saveToLocalStorage();
                    this.render();
                    this.showToast('‚úÖ Task updated!');
                }
            },
            
            async editSubtask(sectionId, taskId, subIdx) {
                const section = this.data.sections.find(s => s.id === sectionId);
                const task = section.tasks.find(t => t.id === taskId);
                const subtask = task.subtasks[subIdx];
                const newText = prompt('Edit subtask:', subtask.text);
                
                if (newText && newText.trim() && newText.trim() !== subtask.text) {
                    subtask.text = newText.trim();
                    await this.saveToLocalStorage();
                    this.render();
                    this.showToast('‚úÖ Subtask updated!');
                }
            },
            
            async deleteTask(sectionId, taskId) {
                if (!confirm('Delete this task?')) return;
                
                const section = this.data.sections.find(s => s.id === sectionId);
                section.tasks = section.tasks.filter(t => t.id !== taskId);
                await this.saveToLocalStorage();
                this.render();
                this.showToast('üóëÔ∏è Task deleted!');
            },
            
            async deleteSubtask(sectionId, taskId, subIdx) {
                if (!confirm('Delete this subtask?')) return;
                
                const section = this.data.sections.find(s => s.id === sectionId);
                const task = section.tasks.find(t => t.id === taskId);
                task.subtasks.splice(subIdx, 1);
                await this.saveToLocalStorage();
                this.render();
                this.showToast('üóëÔ∏è Subtask deleted!');
            },
            
            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2500);
            }
        };
        
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
